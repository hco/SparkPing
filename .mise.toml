[tools]
rust = "1.91.1"
node = "24"
"cargo:cargo-watch" = { version = "latest" }

[settings]
# Enable hooks (required for postinstall hook to work)
experimental = true

[hooks]
# Enabling corepack will install the `pnpm` package manager specified in your package.json
postinstall = "npx corepack enable"

[env]
# Add node_modules/.bin to PATH so binaries installed with pnpm are available
_.path = ["{{config_root}}/frontend/node_modules/.bin"]

[tasks."install:rust"]
description = "Install Rust dependencies"
run = "cargo fetch && touch .cargo-fetched"
sources = ["Cargo.toml", "Cargo.lock"]
outputs = [".cargo-fetched"]

[tasks."install:frontend"]
description = "Install frontend dependencies"
run = "pnpm install"
dir = "frontend"
sources = ["frontend/package.json", "frontend/pnpm-lock.yaml"]
outputs = ["frontend/node_modules/"]

[tasks.install]
description = "Install all dependencies (Rust and frontend)"
depends = ["install:rust", "install:frontend"]

[tasks.build]
description = "Build the project"
depends = ["install"]
run = "cargo build"

[tasks.release]
description = "Build the project in release mode"
depends = ["install"]
run = "cargo build --release"

[tasks.test]
description = "Run tests"
depends = ["install"]
run = "cargo test"

[tasks.check]
description = "Check code without building"
depends = ["install"]
run = "cargo check"

[tasks.fmt]
description = "Format code"
depends = ["install"]
run = "cargo fmt --all"

[tasks.fmt-check]
depends = ["install"]
description = "Check code formatting"
run = "cargo fmt --check --all"

[tasks.clippy]
description = "Run clippy linter"
depends = ["install"]
run = "cargo clippy"

[tasks.clippy-pedantic]
description = "Run clippy with pedantic lints"
depends = ["install"]
run = "cargo clippy -- -W clippy::pedantic"

[tasks.run]
description = "Run the project"
depends = ["install"]
run = '''
if [[ "$(uname)" == "Darwin" ]]; then
  sudo cargo run
else
  cargo run
fi
'''

[tasks.dev]
description = "Run the project with watch support (auto-reload on file changes)"
depends = ["install"]
run = '''
if [[ "$(uname)" == "Darwin" ]]; then
  sudo cargo watch -x run
else
  cargo watch -x run
fi
'''

[tasks.watch-check]
description = "Watch for changes and run cargo check (faster feedback loop)"
depends = ["install"]
run = "cargo watch -x check"

[tasks.clean]
description = "Clean build artifacts"
run = "cargo clean"

[tasks.lint]
description = "Run all linting checks (fmt-check + clippy)"
depends = ["install"]
run = "cargo fmt --check --all && cargo clippy"

[tasks.all]
description = "Run check, fmt-check, and clippy"
depends = ["install"]
run = "cargo check && cargo fmt --check --all && cargo clippy"

[tasks."frontend:dev"]
description = "Start the frontend development server"
depends = ["install"]
dir = "frontend"
run = "pnpm dev"

[tasks."frontend:build"]
description = "Build the frontend for production"
depends = ["install"]
dir = "frontend"
run = "pnpm build"

[tasks."frontend:lint"]
description = "Lint the frontend code"
depends = ["install"]
dir = "frontend"
run = "pnpm lint"

[tasks."frontend:lint-fix"]
description = "Lint the frontend code and fix errors"
depends = ["install"]
dir = "frontend"
run = "pnpm exec eslint . --fix"

[tasks."frontend:type-check"]
description = "Run TypeScript type checking"
depends = ["install"]
dir = "frontend"
run = "pnpm exec tsc --noEmit"

[tasks."frontend:verify"]
depends = ["install", "frontend:type-check", "frontend:lint"]

[tasks."ci"]
description = "Run all CI checks (linting, type checking, and tests)"
depends = ["lint", "frontend:verify", "check", "clippy", "fmt-check"]
