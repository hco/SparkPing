[tools]
rust = { version = "1.91.1", components = "clippy,cargo,rustc,rust-std,rust-analyzer,rustfmt" }
node = "24"
"cargo:cargo-watch" = { version = "latest" }
"npm:release-it" = { version = "latest" }

[settings]
# Enable hooks (required for postinstall hook to work)
experimental = true

[hooks]
# Enabling corepack will install the `pnpm` package manager specified in your package.json
postinstall = "npx corepack enable"

[env]
# Add node_modules/.bin to PATH so binaries installed with pnpm are available
_.path = ["{{config_root}}/frontend/node_modules/.bin"]

# Installation tasks
[tasks."server:install"]
description = "Install server dependencies"
run = "cargo fetch && touch .cargo-fetched"
sources = ["Cargo.toml", "Cargo.lock"]
outputs = [".cargo-fetched"]

[tasks."frontend:install"]
description = "Install frontend dependencies"
run = "pnpm install"
dir = "frontend"
sources = ["frontend/package.json", "frontend/pnpm-lock.yaml"]
outputs = ["frontend/node_modules/"]

[tasks."root:install"]
description = "Install root dependencies (release-it)"
run = "pnpm install"
sources = ["package.json", "pnpm-lock.yaml"]
outputs = ["node_modules/"]

[tasks.install]
description = "Install all dependencies (server, frontend, and root)"
depends = ["server:install", "frontend:install", "root:install"]

# Server tasks
[tasks."server:build"]
description = "Build the server"
depends = ["install"]
run = "cargo build"

[tasks."server:build:release"]
description = "Build the server in release mode"
depends = ["install"]
run = "cargo build --release"

[tasks."server:test"]
description = "Run server tests"
depends = ["install"]
run = "cargo test"

[tasks."server:check"]
description = "Check server code without building"
depends = ["install"]
run = "cargo check"

[tasks."server:fmt"]
description = "Format server code"
depends = ["install"]
run = "cargo fmt --all"

[tasks."server:fmt-check"]
description = "Check server code formatting"
depends = ["install"]
run = "cargo fmt --check --all"

[tasks."server:clippy"]
description = "Run clippy linter on server code"
depends = ["install"]
run = "cargo clippy"

[tasks."server:clippy-pedantic"]
description = "Run clippy with pedantic lints"
depends = ["install"]
run = "cargo clippy -- -W clippy::pedantic"

[tasks."server:lint"]
description = "Run all server linting checks (fmt-check + clippy)"
depends = ["install"]
run = "cargo fmt --check --all && cargo clippy"

[tasks."server:run"]
description = "Run the server"
depends = ["install"]
run = '''
if [[ "$(uname)" == "Darwin" ]]; then
  sudo cargo run
else
  cargo run
fi
'''

[tasks."server:dev"]
description = "Run the server with watch support (auto-reload on file changes)"
depends = ["install"]
run = '''
if [[ "$(uname)" == "Darwin" ]]; then
  sudo cargo watch -x run
else
  cargo watch -x run
fi
'''

[tasks."server:watch-check"]
description = "Watch for changes and run cargo check (faster feedback loop)"
depends = ["install"]
run = "cargo watch -x check"

[tasks."server:clean"]
description = "Clean server build artifacts"
run = "cargo clean"

# Frontend tasks
[tasks."frontend:dev"]
description = "Start the frontend development server"
depends = ["install"]
dir = "frontend"
run = "pnpm dev"

[tasks."frontend:build"]
description = "Build the frontend for production"
depends = ["install"]
dir = "frontend"
run = "pnpm build"

[tasks."frontend:lint"]
description = "Lint the frontend code"
depends = ["install"]
dir = "frontend"
run = "pnpm lint"

[tasks."frontend:lint-fix"]
description = "Lint the frontend code and fix errors"
depends = ["install"]
dir = "frontend"
run = "pnpm exec eslint . --fix"

[tasks."frontend:type-check"]
description = "Run TypeScript type checking"
depends = ["install"]
dir = "frontend"
run = "pnpm exec tsc --noEmit"

[tasks."frontend:verify"]
description = "Verify frontend code (type check + lint)"
depends = ["frontend:type-check", "frontend:lint"]

[tasks."frontend:test"]
description = "Run frontend tests"
depends = ["install"]
dir = "frontend"
run = "pnpm test:run"

[tasks."frontend:test-watch"]
description = "Run frontend tests in watch mode"
depends = ["install"]
dir = "frontend"
run = "pnpm test"

# Combined tasks
[tasks.build]
description = "Build both server and frontend"
depends = ["server:build", "frontend:build"]

[tasks.lint]
description = "Lint both server and frontend"
depends = ["server:lint", "frontend:lint"]

[tasks.develop]
description = "Run both server and frontend in development mode"
depends = ["server:dev", "frontend:dev"]

[tasks.dev]
description = "Alias for develop"
depends = ["develop"]

# CI task
[tasks.ci]
description = "Run all CI checks (linting, type checking, and tests)"
depends = ["server:lint", "frontend:verify", "server:check", "server:clippy", "server:fmt-check"]


[tasks.git-pull-rebase]
description = "Pull and rebase the current branch"
depends = ["install"]
run = "git pull --rebase"
# Release tasks
[tasks.release]
description = "Create a new release (interactive)"
depends = ["install", "git-pull-rebase"]
run = "release-it"

[tasks."release:patch"]
description = "Release a patch version"
depends = ["install", "git-pull-rebase"]
run = "release-it patch --ci"

[tasks."release:minor"]
description = "Release a minor version"
depends = ["install", "git-pull-rebase"]
run = "release-it minor --ci"

[tasks."release:major"]
description = "Release a major version"
depends = ["install", "git-pull-rebase"]
run = "release-it major --ci"

[tasks."release:dry-run"]
description = "Dry run a release (no changes)"
depends = ["install"]
run = "release-it --dry-run"
